<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Veterinario Bianchi - Assistente Virtuale</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2c5530">
    
    <style>
        /* Stili privacy banner */
        #privacy-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #privacy-banner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .banner-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .banner-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .banner-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c5530;
        }

        .banner-text {
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
        }

        .consent-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px;
        }

        .checkbox-container label {
            font-size: 14px;
            line-height: 1.4;
            color: #555;
            cursor: pointer;
        }

        .privacy-link {
            color: #2c5530;
            text-decoration: underline;
            cursor: pointer;
        }

        .privacy-link:hover {
            color: #1a3319;
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-accept {
            background: #2c5530;
            color: white;
        }

        .btn-accept:hover:not(:disabled) {
            background: #1a3319;
        }

        .btn-accept:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .app-disabled {
            pointer-events: none;
            opacity: 0.3;
            filter: blur(2px);
        }

        #privacy-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            margin: 20px;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .privacy-section {
            margin-bottom: 25px;
        }

        .privacy-section h3 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        /* Stili applicazione originale */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .status-indicator {
            background: #4ade80;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            text-align: left;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .bot .message-content {
            background: #e2e8f0;
            color: #334155;
        }

        .user .message-content {
            background: #2c5530;
            color: white;
        }

        .buttons-grid {
            padding: 20px;
            display: grid;
            gap: 10px;
        }

        .emergency-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px 8px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
            font-weight: 500;
        }

        .action-btn:hover {
            border-color: #2c5530;
            color: #2c5530;
            transform: translateY(-1px);
        }

        .input-section {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #messageInput:focus {
            border-color: #2c5530;
        }

        #sendButton {
            background: #2c5530;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #sendButton:hover {
            background: #1a3319;
            transform: scale(1.05);
        }

        .typing-indicator {
            display: none;
            text-align: left;
            margin-bottom: 15px;
        }

        .typing-dots {
            background: #e2e8f0;
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            color: #64748b;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 80% { content: '...'; }
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Privacy Overlay -->
    <div id="privacy-overlay">
        <div id="privacy-banner">
            <div class="banner-header">
                <span class="banner-icon">🏥</span>
                <div class="banner-title">Studio Veterinario Bianchi</div>
            </div>
            
            <div class="banner-text">
                <strong>Informativa Privacy e Consenso al Trattamento Dati</strong>
                <br><br>
                Per utilizzare questo servizio di assistenza veterinaria, raccogliamo e trattiamo i tuoi dati personali in conformità al GDPR (Regolamento UE 2016/679).
            </div>

            <div class="consent-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="privacy-consent" required>
                    <label for="privacy-consent">
                        Ho letto e accetto l'<span class="privacy-link" onclick="showPrivacyModal()">Informativa sulla Privacy</span> e acconsento al trattamento dei miei dati personali per ricevere assistenza veterinaria tramite questo chatbot.
                    </label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="data-processing" required>
                    <label for="data-processing">
                        Comprendo che i miei messaggi saranno inviati al veterinario per fornire assistenza e che i dati saranno conservati per 30 giorni per finalità di servizio.
                    </label>
                </div>
            </div>

            <div class="buttons-container">
                <button class="btn btn-accept" id="accept-btn" disabled onclick="acceptPrivacy()">
                    Accetta e Continua
                </button>
                <button class="btn btn-reject" onclick="rejectPrivacy()">
                    Rifiuta
                </button>
            </div>
        </div>
    </div>

    <!-- Applicazione principale -->
    <div class="container app-disabled" id="main-app">
        <div class="header">
            <div>
                <h2>🏥 Studio Veterinario Bianchi</h2>
                <p>Online <span class="status-indicator"></span> Risponde subito</p>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot">
                <div class="message-content">
                    🐕 Ciao! Sono l'assistente virtuale dello Studio Veterinario Bianchi. Come posso aiutarti oggi?
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots"></div>
        </div>

        <div class="buttons-grid">
            <button class="emergency-btn" onclick="handleEmergency()">
                🚨 EMERGENZA
            </button>
            
            <div class="action-grid">
                <button class="action-btn" onclick="handleQuickAction('orari')">
                    🕐 Orari
                </button>
                <button class="action-btn" onclick="handleQuickAction('prezzi')">
                    💰 Prezzi
                </button>
                <button class="action-btn" onclick="handleQuickAction('dove')">
                    📍 Dove siamo
                </button>
                <button class="action-btn" onclick="handleQuickAction('prenotazioni')">
                    📞 Prenotazioni
                </button>
                <button class="action-btn" onclick="handleQuickAction('servizi')">
                    🏥 Servizi
                </button>
                <button class="action-btn" onclick="handleQuickAction('preparazione')">
                    📋 Come preparare animale
                </button>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Scrivi la tua domanda..." onkeypress="handleKeyPress(event)">
                <button id="sendButton" onclick="sendMessage()">Invia</button>
            </div>
        </div>
    </div>

    <!-- Modal Privacy Policy -->
    <div id="privacy-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Informativa sulla Privacy - Studio Veterinario Bianchi</h2>
                <button class="close-btn" onclick="hidePrivacyModal()">&times;</button>
            </div>
            
            <div class="privacy-section">
                <h3>1. Titolare del Trattamento</h3>
                <p>Studio Veterinario Bianchi<br>
                Via Roma 123, Brescia<br>
                Email: info@veterinariobianchi.it<br>
                Tel: 030-123456</p>
            </div>

            <div class="privacy-section">
                <h3>2. Dati Raccolti</h3>
                <p>Raccogliamo i seguenti dati personali:</p>
                <ul>
                    <li>Messaggi inviati tramite il chatbot</li>
                    <li>Indirizzo IP e dati tecnici di connessione</li>
                    <li>Timestamp delle conversazioni</li>
                    <li>Informazioni sui tuoi animali domestici (se fornite)</li>
                </ul>
            </div>

            <div class="privacy-section">
                <h3>3. Finalità del Trattamento</h3>
                <p>I tuoi dati sono trattati per:</p>
                <ul>
                    <li>Fornire assistenza veterinaria tramite chatbot</li>
                    <li>Rispondere alle tue richieste di informazioni</li>
                    <li>Gestire emergenze veterinarie</li>
                    <li>Migliorare il servizio offerto</li>
                </ul>
            </div>

            <div class="privacy-section">
                <h3>4. Base Giuridica</h3>
                <p>Il trattamento è basato sul tuo consenso esplicito (Art. 6, comma 1, lett. a GDPR).</p>
            </div>

            <div class="privacy-section">
                <h3>5. Conservazione dei Dati</h3>
                <p>I dati sono conservati per 30 giorni dalla raccolta, salvo diversi obblighi di legge.</p>
            </div>

            <div class="privacy-section">
                <h3>6. Condivisione dei Dati</h3>
                <p>I tuoi messaggi sono condivisi esclusivamente con il veterinario dello studio per fornire assistenza. Non condividiamo dati con terzi salvo obblighi di legge.</p>
            </div>

            <div class="privacy-section">
                <h3>7. I Tuoi Diritti</h3>
                <p>Hai diritto a:</p>
                <ul>
                    <li>Accesso ai tuoi dati</li>
                    <li>Rettifica di dati inesatti</li>
                    <li>Cancellazione dei dati</li>
                    <li>Limitazione del trattamento</li>
                    <li>Portabilità dei dati</li>
                    <li>Revoca del consenso in qualsiasi momento</li>
                </ul>
                <p>Per esercitare i tuoi diritti, contatta: info@veterinariobianchi.it</p>
            </div>

            <div class="privacy-section">
                <h3>8. Sicurezza</h3>
                <p>Adottiamo misure tecniche e organizzative appropriate per proteggere i tuoi dati personali.</p>
            </div>

            <div class="privacy-section">
                <h3>9. Cookie</h3>
                <p>Questo sito utilizza cookie tecnici necessari per il funzionamento del servizio.</p>
            </div>

            <div class="privacy-section">
                <h3>10. Modifiche</h3>
                <p>Questa informativa può essere aggiornata. Le modifiche saranno pubblicate su questa pagina.</p>
                <p><strong>Ultimo aggiornamento:</strong> 27 agosto 2025</p>
            </div>
        </div>
    </div>

    <script>
        // Gestione consenso privacy
        function updateAcceptButton() {
            const privacyConsent = document.getElementById('privacy-consent').checked;
            const dataProcessing = document.getElementById('data-processing').checked;
            const acceptBtn = document.getElementById('accept-btn');
            
            acceptBtn.disabled = !(privacyConsent && dataProcessing);
        }

        document.getElementById('privacy-consent').addEventListener('change', updateAcceptButton);
        document.getElementById('data-processing').addEventListener('change', updateAcceptButton);

        function acceptPrivacy() {
            document.getElementById('privacy-overlay').style.display = 'none';
            document.getElementById('main-app').classList.remove('app-disabled');
            console.log('Consenso privacy accettato');
        }

        function rejectPrivacy() {
            alert('Senza il consenso al trattamento dei dati personali non è possibile utilizzare il servizio di assistenza veterinaria.\n\nLa pagina verrà chiusa.');
            
            document.getElementById('main-app').innerHTML = 
                '<div style="text-align: center; padding: 50px;"><h2>Servizio non disponibile</h2><p>Hai rifiutato il consenso al trattamento dei dati personali.</p><p>Per utilizzare il servizio, ricarica la pagina e accetta l\'informativa privacy.</p><button onclick="location.reload()">Ricarica Pagina</button></div>';
            
            document.getElementById('privacy-overlay').style.display = 'none';
            document.getElementById('main-app').classList.remove('app-disabled');
        }

        function showPrivacyModal() {
            document.getElementById('privacy-modal').style.display = 'flex';
        }

        function hidePrivacyModal() {
            document.getElementById('privacy-modal').style.display = 'none';
        }

        // Funzioni chatbot originali
        const responses = {
            orari: "🕐 <strong>Orari di apertura:</strong><br><br>📅 Lunedì-Venerdì: 8:00-19:00<br>📅 Sabato: 8:00-12:00<br>📅 Domenica: Emergenze: 10:00-12:00",
            prezzi: "💰 <strong>Prezzi indicativi:</strong><br><br>• Visita generale: €50-80<br>• Vaccinazione: €35-60<br>• Microchip: €25<br>• Sterilizzazione cane: €180-350<br>• Sterilizzazione gatto: €120-200<br>• Radiografia: €80-120<br>• Analisi sangue: €40-80<br><br><em>I prezzi possono variare in base al caso specifico.</em>",
            dove: "📍 <strong>Dove siamo:</strong><br><br>🏥 Studio Veterinario Bianchi<br>📍 Via Roma 123, Brescia<br>☎️ 030-123456<br>📧 info@veterinariobianchi.it",
            prenotazioni: "📅 <strong>Per prenotare:</strong><br><br>☎️ Chiama: 030-123456<br>📧 Email: info@veterinariobianchi.it<br><br><em>Ti ricontatteremo il prima possibile!</em>",
            servizi: "🏥 <strong>I nostri servizi:</strong><br><br>• Visite generali<br>• Vaccinazioni<br>• Chirurgia<br>• Radiografie<br>• Analisi del sangue<br>• Microchip<br>• Sterilizzazioni<br>• Emergenze 24h",
            preparazione: "📋 <strong>Come preparare l'animale:</strong><br><br>🐕 <strong>Per visite:</strong><br>• Digiuno di 12h se previsti esami del sangue<br>• Portare libretto vaccinazioni<br>• Guinzaglio per cani, trasportino per gatti<br><br>🔬 <strong>Per esami:</strong><br>• Seguire le indicazioni specifiche date<br>• Raccolta urine: contenitore sterile<br><br>💊 <strong>Terapie in corso:</strong><br>• Elenco farmaci attuali<br>• Non sospendere senza indicazione"
        };

        function addMessage(content, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function handleQuickAction(action) {
            const response = responses[action];
            if (response) {
                showTyping();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideTyping();
                addMessage(response);
            }
        }

        async function handleEmergency() {
            addMessage("🚨 EMERGENZA ATTIVATA! Stiamo allertando il veterinario...", true);
            showTyping();
            
            try {
                const response = await fetch('https://1chatbot-veterinario.vercel.app/api/emergency', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timestamp: new Date().toISOString() })
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                hideTyping();
                
                if (response.ok) {
                    addMessage("🚨 <strong>EMERGENZA REGISTRATA!</strong><br><br>✅ Il veterinario è stato allertato<br>📞 Se non ricevi risposta in 5 minuti, ti chiameremo automaticamente<br><br>Per emergenze immediate chiama: <strong>030-123456</strong>");
                } else {
                    addMessage("❌ Errore nella segnalazione emergenza.<br><br>📞 <strong>CHIAMA SUBITO: 030-123456</strong>");
                }
            } catch (error) {
                hideTyping();
                addMessage("❌ Errore di connessione.<br><br>📞 <strong>CHIAMA SUBITO: 030-123456</strong>");
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                showTyping();
                
                try {
                    const response = await fetch('https://1chatbot-veterinario.vercel.app/api/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message, clientId: 'web-' + Date.now() })
                    });
                    
                    const data = await response.json();
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    hideTyping();
                    
                    if (data.response) {
                        addMessage(data.response);
                    } else {
                        addMessage("Mi dispiace, non ho capito la tua richiesta. Puoi riprovare o usare i pulsanti qui sotto per le domande più comuni.");
                    }
                } catch (error) {
                    hideTyping();
                    addMessage("Ciao! 🐕 Posso aiutarti con:<br><br>• Orari di apertura<br>• Servizi disponibili<br>• Prezzi<br>• Contatti<br>• Prenotazioni<br>• Emergenze<br><br>Usa i pulsanti qui sotto o scrivi la tua domanda!");
                }
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    </script>
</body>
</html>

